<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/scss/main.scss" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <main class="cb-l-user_profile">
      <nav class="cb-c-navbar">
        <a class="cb-c-navbar__logo" href="/index.html">Caber</a>
        <ul class="cb-c-navbar__menu">
          <a
            class="cb-c-navbar__menu__item js-passenger-role"
            href="/app/bookcab.html"
            >Book a ride</a
          >

          <a
            class="cb-c-navbar__menu__item js-driver-role"
            href="/app/driver/driverCabs.html"
            >My Cabs</a
          >
          <a
            class="cb-c-navbar__menu__item js-passenger-role"
            href="/app/myrides.html"
            >My Rides</a
          >
          <a
            class="cb-c-navbar__menu__item js-driver-role"
            href="/app/driver/rideRequests.html"
            >Ride Requests</a
          >
          <a class="cb-c-navbar__menu__item" href="#">Profile</a>
        </ul>
      </nav>
      <div class="cb-l-user_profile__card">
        <img src="" alt="" />
        <p>Zain Kadar</p>
        <p>Joined</p>
        <button class="cb-c-button cb-c-button--secondary" id="js-logout">
          Logout
        </button>
      </div>
      <div class="cb-l-user_profile__sections">
        <button class="cb-l-user_profile__edit_button">
          <span><i class="fa-solid fa-pencil"></i> Edit</span>
        </button>
        <section class="cb-l-user_profile__section">
          <p class="cb-l-user_profile__section__title">General</p>
          <div class="cb-l-user_profile__section__entries">
            <div class="cb-l-user_profile__section__entry">
              <i></i>
              <p>Zain Kadar</p>
            </div>
            <div class="cb-l-user_profile__section__entry">
              <i></i>
              <p>somone@gmail.com</p>
            </div>
            <div class="cb-l-user_profile__section__entry">
              <i></i>
              <p>+01 12132 21321</p>
            </div>
          </div>
        </section>
        <section id="cb-js-ride-history-group"></section>
      </div>
      <script>
        if (!localStorage.getItem("token")) {
          window.location.href = "/app/login.html";
        }

        $(document).ready(() => {
          const role = localStorage.getItem("role");

          if (role === "Driver") {
            $(".js-passenger-role").remove();
          } else {
            $(".js-driver-role").remove();
          }
        });

        $(".cb-l-user_profile__edit_button").click(() => {
          window.toggleModal({
            title: "Edit Profile",
            content: `
              <form class="cb-c-form">
                <h1 class="cb-c-form__title">Edit Profile</h1>
                <div class="cb-c-form__group">
                  <label for="name">Name</label>
                  <input type="text" id="name" />
                </div>
                <div class="cb-c-form__group">
                  <label for="email">Email</label>
                  <input type="email" id="email" />
                </div>
                <div class="cb-c-form__group">
                  <label for="phone">Phone</label>
                  <input type="tel" id="phone" />
                </div>
                <div class="cb-c-form__action">
                  <button class="cb-c-button">Save</button>
                </div>
              </form>
            `,
          });
        });

        $(document).on("click", function (e) {
          if (e.target.id !== "js-logout") return;

          localStorage.removeItem("token");
          localStorage.removeItem("role");
          window.location.href = "/app/login.html";
        });
      </script>

      <script>
        function loadRides(history) {
          const rideHistoryGroup = $("#cb-js-ride-history-group");
          rideHistoryGroup.empty();

          rideHistoryGroup.append(
            '<p class="cb-l-user_profile__section__title">Ride History</p>'
          );
          if (history.length === 0) {
            rideHistoryGroup.append(`
              <div class="cb-c-alert cb-c-alert--info">
                <p>No ride history</p>
              </div>
            `);
          } else {
            history.forEach((ride) => {
              const historyRideCard = `
              <div class="cb-c-ride-card">
                <img
                  class="cb-c-ride-card__image"
                  src="/assets/ride_cab.png"
                  alt=""
                />
                <div class="cb-c-ride-card__ride_details">
                  <h2 class="cb-c-ride-card__cab">${ride.cab.make} ${
                ride.cab.model
              }</h2>
                  <p class="cb-c-ride-card__ride-date">${new Date(
                    ride.startTime
                  ).toLocaleDateString("en-IN", {
                    day: "2-digit",
                    month: "long",
                    year: "numeric",
                  })}</p>
                  <p class="cb-c-ride-card__status">${ride.status}</p>
                </div>
                <div class="cb-c-ride-card__price_container">
                 <p class="cb-c-ride-card__price">${
                   ride.status === "Completed" ? ride.fare : "---$"
                 }</p>
                </div>
              </div>
              `;
              rideHistoryGroup.append(historyRideCard);
            });
          }
        }

        $(document).ready(() => {
          fetch("http://localhost:8000/api/Passenger/ride-history", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          })
            .then((res) => res.json())
            .then((data) => {
              let rideHistory = [];

              data.forEach((ride) => {
                if (
                  !["InProgress", "Accepted", "Requested"].includes(ride.status)
                ) {
                  rideHistory.push(ride);
                }
              });

              loadRides(rideHistory);
            });
        });
      </script>
      <script src="/js/modalscript.js"></script>
      <script src="/js/toastscript.js"></script>
    </main>
  </body>
</html>
