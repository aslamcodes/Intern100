<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../scss/main.scss" />
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <nav class="cb-c-navbar">
      <h1 class="cb-c-navbar__logo">Caber</h1>
      <ul class="cb-c-navbar__menu">
        <li class="cb-c-navbar__menu__item">Book a ride</li>
        <a href="myrides.html" class="cb-c-navbar__menu__item">My Rides</a>
        <a href="user/profile.html" class="cb-c-navbar__menu__item">Profile</a>
      </ul>
    </nav>
    <main class="cb-l-book_cab_page">
      <form class="cb-c-form">
        <h1 class="cb-c-form__title">Book a Ride</h1>
        <div class="cb-c-form__group">
          <label for="from">From</label>
          <input type="text" id="from" />
          <p id="fromError" class="cb-ut-form-error"></p>
        </div>
        <div class="cb-c-form__group">
          <label for="to">To</label>
          <input type="text" id="to" />
          <p id="toError" class="cb-ut-form-error"></p>
        </div>
        <div class="cb-c-form__group">
          <label for="seating">Seating</label>
          <input type="number" id="seating" />
          <p id="seatingError" class="cb-ut-form-error"></p>
        </div>
        <div class="cb-c-form__action">
          <button class="cb-c-button" type="submit">Book Any</button>
          <p>or</p>
          <button class="cb-c-button--secondary" type="submit">
            Search for Cabs
          </button>
        </div>
      </form>
      <div class="cb-l-cab_grid">
        <div class="cb-c-cab_card">
          <p>Search For Cabs</p>
        </div>
      </div>
    </main>
    <script src="/js/toastscript.js"></script>
    <script>
      function loadCabs(cabs) {
        const cabGrid = $(".cb-l-cab_grid");

        cabGrid.empty();

        if (cabs.length === 0) {
          cabGrid.append("<p>No cabs found</p>");
        }

        cabs.forEach((cab) => {
          const cabCard = `
            <div class="cb-c-cab_card">
              <img
                src="https://i.pinimg.com/736x/e4/2a/77/e42a772f947fadb287486d2743655538.jpg"
                alt=""
                class="cb-c-cab_card__img"
              />
              <div class="cb-c-cab_card__details">
                <h2 class="cb-l-cab_grid__cab__name">${cab.make} ${cab.model}</h2>
              </div>
                <p class="cb-l-cab_grid__cab__rating">Rating: ${cab.registrationNumber}</p>

              <p class="cb-c-cab_card__seating">Max: ${cab.seatingCapacity}</p>
              <p class="cb-c-cab_card__seating">Currently at: ${cab.location}</p>
              <button class="cb-c-cab_card__book" id="js_book_cab" data-cabId="${cab.id}">Book this cab</button>
            </div>
          `;

          cabGrid.append(cabCard);
        });
      }

      const rideReqObj = {
        from: "",
        to: "",
        seating: "",
      };

      $(document).on("click", "button", function (e) {
        if (e.target.id === "js_book_cab") {
          const cabId = $(e.target).data("cabid");
          const token = localStorage.getItem("token");

          fetch("http://localhost:8000/api/Passenger/book-cab", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              cabId,
              pickupLocation: rideReqObj.from,
              dropoffLocation: rideReqObj.to,
              seatingCapacity: rideReqObj.seating,
              passengerId: 1,
            }),
          }).then((res) => {
            if (res.status === 200) {
              window.showToast("Cab booked", "success", 1500, function () {
                location.href = "/app/myrides.html";
              });
            } else {
              window.showToast("Cab not booked", "error", 3000);
            }
          });
        }
      });

      $(document).ready(function () {
        $(".cb-c-form").submit(function (e) {
          e.preventDefault();

          const token = localStorage.getItem("token");

          if (!token) {
            window.location.href = "login.html";
          }

          const from = $("#from").val();
          const to = $("#to").val();
          const seating = $("#seating").val();

          let isFormValid = true;

          let fromError = $("#fromError");
          let toError = $("#toError");
          let seatingError = $("#seatingError");

          if (from === "") {
            fromError.text("From is required");
            isFormValid = false;
          } else {
            fromError.text("");
            isFormValid = true;
          }

          if (to === "") {
            toError.text("To is required");
            isFormValid = false;
          } else {
            toError.text("");
            isFormValid = true;
          }

          if (seating === "") {
            seatingError.text("Seating is required");
            isFormValid = false;
          } else {
            seatingError.text("");
            isFormValid = true;
          }

          if (isFormValid) {
            rideReqObj.from = from;
            rideReqObj.to = to;
            rideReqObj.seating = seating;

            fetch(
              "http://localhost:8000/api/Cab?" +
                new URLSearchParams({
                  location: from,
                  seatingCapacity: seating,
                }).toString(),
              {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                method: "GET",
              }
            )
              .then((res) => res.json())
              .then((data) => {
                loadCabs(data);
              })
              .catch((err) => {
                console.log(err);
              });
          }
        });
      });
    </script>
  </body>
</html>
