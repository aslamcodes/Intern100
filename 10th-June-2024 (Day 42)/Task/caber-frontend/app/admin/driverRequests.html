<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="/scss/main.scss" />
  </head>

  <body>
    <header>
      <nav class="cb-c-navbar">
        <h1 class="cb-c-navbar__logo">Caber</h1>
        <ul class="cb-c-navbar__menu">
          <a
            class="cb-c-navbar__menu__item js-admin-role"
            href="/app/admin/manageCabs.html"
            >Manage Cabs</a
          >
          <a class="cb-c-navbar__menu__item js-admin-role" href="#"
            >Manage Drivers</a
          >
          <a
            class="cb-c-navbar__menu__item js-admin-role"
            href="/app/user/profile.html"
            >Profile</a
          >
        </ul>
        <div class="cb-c-navbar__mobile_menu" id="js-mobile_menu">
          <img src="/assets/Icons/bars-3-bottom-right.svg" />
        </div>
      </nav>
      <nav class="cb-c-sidebar" id="js-sidebar">
        <i class="fa fa-close" id="js-sidebar-close"></i>
      </nav>
    </header>

    <main class="cb-ut-main_wrapper">
      <h1 style="margin-left: 20px">Drivers</h1>
      <div
        class="cb-c-controls cb-c-controls--start"
        style="padding-left: 1.1rem"
      >
        <div class="cb-c-search">
          <div class="cb-c-search__icon">
            <i class="fa fa-search"></i>
          </div>

          <input
            class="cb-c-search__input"
            id="js-search-drivers"
            placeholder="Search in Drivers"
          />
        </div>
        <button class="cb-c-icon_button" id="js-filter-driver">
          <i class="cb-c-icon_button__icon fa fa-filter"></i>
        </button>
        <button class="cb-c-icon_button" id="js-sort-driver">
          <i class="cb-c-icon_button__icon fa fa-sort"></i>
        </button>
      </div>
      <div class="cb-c-floating_menu hidden" id="filter_menu">
        <!-- <div class="cb-c-floating_menu__option" id="js-filter-by-active">
          <i class="fa-solid fa-circle"></i>
          <p>Active Cabs</p>
        </div>
        <div class="cb-c-floating_menu__option" id="js-filter-by-offline">
          <i class="fa-regular fa-circle"></i>
          <p>Offline Cabs</p>
        </div>
        <div class="cb-c-floating_menu__option" id="js-clear-filters">
          <i class="fa-regular fa-circle-xmark"></i>
          <p>Clear Filters</p>
        </div> -->
        <!-- 1. Filter by verification
         -->
        <div class="cb-c-floating_menu__option" id="js-filter-by-verified">
          <i class="fa-solid fa-check"></i>
          <p>Verified Drivers</p>
        </div>
        <div class="cb-c-floating_menu__option" id="js-filter-by-non-verified">
          <i class="fa-regular fa-circle"></i>
          <p>Non-Verified Drivers</p>
        </div>
        <div class="cb-c-floating_menu__option" id="js-clear-filters">
          <i class="fa-regular fa-circle-xmark"></i>
          <p>Clear Filters</p>
        </div>
      </div>
      <div class="cb-c-floating_menu hidden" id="sort_menu">
        <div class="cb-c-floating_menu__option" id="js-sort-by-name">
          <i class="fa-solid fa-sort-alpha-up"></i>
          <p>Sort by Name</p>
        </div>
        <div class="cb-c-floating_menu__option" id="js-sort-by-name-desc">
          <i class="fa-solid fa-sort-alpha-down"></i>
          <p>Sort by Name Desc</p>
        </div>
        <div class="cb-c-floating_menu__option" id="js-clear-sort">
          <i class="fa-regular fa-circle-xmark"></i>
          <p>Clear Sort</p>
        </div>
      </div>
      <section class="cb-l-admin_drivers" id="js-driver-list"></section>
    </main>

    <script>
      window.loadDrivers = function (drivers) {
        $("#js-driver-list").empty();
        drivers.forEach((element) => {
          $("#js-driver-list").append(`<div class="driver-card">
                                              <img src="http://localhost:8000/api/Image?id=${
                                                element.user.userImageId
                                              }" alt="" class="driver-card__image" />
                                              <h1 class="driver-card__name">${
                                                element.user.firstName
                                              }</h1>
                                              <p class="driver-card__email">Email: ${
                                                element.user.email
                                              }</p>
                                              <p class="driver-card__phone">Phone: ${
                                                element.user.phone
                                              }</p>
                                              <p class="driver-card__license">
                                                License number ${
                                                  element.licenseNumber
                                                }
                                              </p>
                                              <p>
                                                Expires at ${
                                                  element.licenseExpiryDate
                                                }
                                              </p>

                                                ${
                                                  element.isVerified
                                                    ? "<p class='driver-card__verified'>Driver is Verified</p>"
                                                    : `<button class="cb-c-button" id="js-${element.driverId}">Verify</button>`
                                                }
                                             </div>`);
        });
      };

      $(document).ready(() => {
        let token = localStorage.getItem("token");

        if (!token) {
          window.location.href = "/app/login.html";
        }

        fetch("http://localhost:8000/api/Admin/get-drivers", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              return Promise.reject("Problem loading drivers");
            }
          })
          .then((data) => {
            window.drivers = data;
            window.loadDrivers(data);
          })
          .catch((err) => {
            window.showToast(err, "error", 2000);
          });
      });

      $(document).on("click", "button", function (e) {
        let pattern = new RegExp("^js-[0-9]+$");

        if (!pattern.test(e.target.id)) return;

        let driverId = e.target.id.split("-")[1];
        let token = localStorage.getItem("token");
        alert(driverId);
        fetch(`http://localhost:8000/api/Admin/verify-driver`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ driverId: driverId }),
        }).then((res) => {
          if (res.ok) {
            window.showToast("Driver verified", "success", 1500, function () {
              location.reload();
            });
          } else {
            window.showToast("Driver not verified", "error", 1500);
          }
        });
      });
    </script>

    <script>
      $("#js-filter-driver").on("click", function () {
        $("#filter_menu").toggleClass("hidden");

        let position = $("#js-filter-driver").position();

        $("#filter_menu").css({
          top: position.top,
          left: position.left,
        });
      });

      $("#js-sort-driver").on("click", function () {
        $("#sort_menu").toggleClass("hidden");

        let position = $("#js-sort-driver").position();
        let height = $("#js-sort-driver").height();
        let width = $("#js-sort-driver").width();

        $("#sort_menu").css({
          top: position.top,
          left: position.left,
        });
      });

      $(window).click(function (e) {
        if (!$(e.target).is("#js-sort-driver")) {
          $("#sort_menu").addClass("hidden");
        }

        if (!$(e.target).is("#js-filter-driver")) {
          $("#filter_menu").addClass("hidden");
        }
      });

      $("#js-search-drivers").on("keyup", function () {
        window.searchQuery = $("#js-search-drivers").val();
        updateDrivers();
      });
    </script>

    <script>
      // filters and sorting
      $(document).on("click", ".cb-c-floating_menu__option", function (e) {
        let id = e.target.id;

        if (id === "js-filter-by-verified") {
          window.filters = { isVerified: true };
        } else if (id === "js-filter-by-non-verified") {
          window.filters = { isVerified: false };
        } else if (id === "js-clear-filters") {
          window.filters = {};
        } else if (id === "js-sort-by-name") {
          window.drivers.sort((a, b) => {
            return a.user.firstName.localeCompare(b.user.firstName);
          });
        } else if (id === "js-sort-by-name-desc") {
          window.drivers.sort((a, b) => {
            return b.user.firstName.localeCompare(a.user.firstName);
          });
        } else if (id === "js-clear-sort") {
          window.drivers = window.drivers.sort((a, b) => {
            return a.driverId - b.driverId;
          });
        }

        window.updateDrivers();
      });
    </script>

    <script>
      function updateDrivers() {
        let search = window.searchQuery || "";
        let filter = window.filters || {};
        let drivers = window.drivers;

        if (search) {
          drivers = drivers.filter((driver) => {
            return JSON.stringify(driver).includes(search);
          });
        }

        if (filter) {
          drivers = drivers.filter((driver) => {
            return Object.keys(filter).every((key) => {
              return driver[key] === filter[key];
            });
          });
        }

        window.loadDrivers(drivers);
      }
    </script>
    <script src="/js/utils.js"></script>
    <script src="/js/navbarscript.js"></script>
    <script src="/js/toastscript.js"></script>
  </body>
</html>
